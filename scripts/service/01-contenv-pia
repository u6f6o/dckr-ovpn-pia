#!/usr/bin/with-contenv bash

# read credentials from environment
echo ${PIA_USER} > /etc/openvpn/auth
echo -n ${PIA_PASSWORD} >> /etc/openvpn/auth

# link region
rm -f /etc/openvpn/service.conf

# check if region file exists
if [ ! -e /etc/openvpn/${PIA_REGION}.ovpn ]; then 
	echo "Region file ${PIA_REGION}.ovpn does not exist!"
    exit 1
fi

ln -s /etc/openvpn/${PIA_REGION}.ovpn /etc/openvpn/service.conf

# use our script instead
echo "iproute /usr/local/sbin/unpriv-ip"  >> /etc/openvpn/service.conf
echo "dev tun0"  >> /etc/openvpn/service.conf
echo "persist-tun"  >> /etc/openvpn/service.conf

usermod -a -G netdev openvpn

# make tun
openvpn --rmtun --dev tun0
openvpn --mktun --dev tun0 --dev-type tun --user openvpn --group openvpn